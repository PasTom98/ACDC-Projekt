pipeline{
    environment {     
    SSH_VM = credentials('acdc_presentation_pw')     
    }
    agent {
        label 'deploy'
        }
        def remote = [:]
        remote.name = 'debian'
        remote.host = 'debian@localhost'
        remote.user = '$SSH_VM_USR'
        remote.password = '$SSH_VM_PW'
        remote.allowAnyHosts = true
    stages{
        stage("Remove old Docker files") {
            steps{
                script{
                    sshScript remote: remote, script "prune_docker.sh"
                }
            }
        }
        stage("Pull Docker-Image") {
            steps{
                script{
                sh 'ssh -tto StrictHostKeyChecking=no debian@localhost -p 22022 ./deploy.sh'
                sh 'echo $SSH_VM_PW'
                }
            }
        }
        stage("Start container"){
            steps{
                script {
                    sh 'ssh -tto StrictHostKeyChecking=no debian@localhost -p 22022 "docker run --name acdc --publish 8080:8080 -d pato98/acdc_presentation && docker run --name db --publish 3308:3306 -d pato98/acdc_db_presentation"'
                    sh 'echo $SSH_VM_PW'
                }
            }
        }
        stage("Connect both containers via network"){
            steps{
                script{
                    sh 'ssh -tto StrictHostKeyChecking=no debian@localhost -p 22022 "docker network create acdc_lamp && docker network connect acdc_lamp acdc && docker network connect acdc_lamp db"'
                    sh 'echo $SSH_VM_PW'
                }
            }
        }
    }
}